{{define "view"}}
<!-- OLD SCRIPTS - Preserved for rollback
<script src="/scripts/core/session-manager.js"></script>
<script src="/scripts/core/auth.js"></script>
<script src="/scripts/systems/theme-manager.js"></script>
<script src="/scripts/systems/relay-manager.js"></script>
-->

<!-- NEW ES6 MODULE BUNDLE -->
<script type="module" src="/dist/settings.js"></script>

<div class="rounded-xl shadow-xl overflow-hidden win95-outset mt-4">
  <div class="p-6 md:p-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <a href="/" class="text-2xl hover:opacity-80">‚Üê</a>
        <h1 class="text-3xl font-bold" style="color: var(--color-textHighlighted);">
          ‚öôÔ∏è Settings
        </h1>
      </div>
      <p style="color: var(--color-textMuted);">Customize your Pubkey Quest experience</p>
    </div>

    <!-- Theme Selector Section -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold mb-4">üé® Theme</h2>
      <p class="mb-4 text-sm" style="color: var(--color-textSecondary);">
        Choose your preferred color theme. All UI elements will adapt to your selection.
      </p>

      <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <!-- Dark Theme -->
        <button onclick="selectTheme('dark')" class="theme-option win95-outset p-4 rounded-lg pixel-clip" data-theme="dark">
          <div class="theme-swatch mb-2" style="background: linear-gradient(135deg, rgb(16, 16, 16) 0%, rgb(40, 40, 40) 50%, rgb(149, 40, 244) 100%);"></div>
          <div class="text-sm font-bold">Dark</div>
          <div class="text-xs" style="color: var(--color-textMuted);">Default</div>
        </button>

        <!-- Light Theme -->
        <button onclick="selectTheme('light')" class="theme-option win95-outset p-4 rounded-lg pixel-clip" data-theme="light">
          <div class="theme-swatch mb-2" style="background: linear-gradient(135deg, rgb(230, 230, 230) 0%, rgb(200, 200, 200) 50%, rgb(149, 40, 244) 100%);"></div>
          <div class="text-sm font-bold">Light</div>
          <div class="text-xs" style="color: var(--color-textMuted);">Bright</div>
        </button>

        <!-- Midnight Theme -->
        <button onclick="selectTheme('midnight')" class="theme-option win95-outset p-4 rounded-lg pixel-clip" data-theme="midnight">
          <div class="theme-swatch mb-2" style="background: linear-gradient(135deg, rgb(25, 24, 48) 0%, rgb(31, 31, 65) 50%, rgb(250, 208, 0) 100%);"></div>
          <div class="text-sm font-bold">Midnight</div>
          <div class="text-xs" style="color: var(--color-textMuted);">Purple Night</div>
        </button>

        <!-- Lava Theme -->
        <button onclick="selectTheme('lava')" class="theme-option win95-outset p-4 rounded-lg pixel-clip" data-theme="lava">
          <div class="theme-swatch mb-2" style="background: linear-gradient(135deg, rgb(57, 0, 0) 0%, rgb(97, 0, 0) 50%, rgb(255, 114, 154) 100%);"></div>
          <div class="text-sm font-bold">Lava</div>
          <div class="text-xs" style="color: var(--color-textMuted);">Fire Red</div>
        </button>

        <!-- Solar Theme -->
        <button onclick="selectTheme('solar')" class="theme-option win95-outset p-4 rounded-lg pixel-clip" data-theme="solar">
          <div class="theme-swatch mb-2" style="background: linear-gradient(135deg, rgb(0, 43, 54) 0%, rgb(7, 54, 66) 50%, rgb(38, 139, 210) 100%);"></div>
          <div class="text-sm font-bold">Solar</div>
          <div class="text-xs" style="color: var(--color-textMuted);">Ocean Blue</div>
        </button>

        <!-- Matrix Theme -->
        <button onclick="selectTheme('matrix')" class="theme-option win95-outset p-4 rounded-lg pixel-clip" data-theme="matrix">
          <div class="theme-swatch mb-2" style="background: linear-gradient(135deg, rgb(0, 0, 0) 0%, rgb(0, 20, 0) 50%, rgb(0, 255, 65) 100%);"></div>
          <div class="text-sm font-bold">Matrix</div>
          <div class="text-xs" style="color: var(--color-textMuted);">Terminal Green</div>
        </button>
      </div>
    </div>

    <!-- Relay Management Section -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold mb-4">üì° Nostr Relays</h2>
      <p class="mb-4 text-sm" style="color: var(--color-textSecondary);">
        The client handles Nostr login and basic authentication, but relay selection is currently a placeholder while the game is in development.
      </p>

      <div class="win95-inset p-4 rounded-lg mb-4">
        <div id="relay-list" class="space-y-2">
          <!-- Relays will be dynamically inserted here -->
        </div>
      </div>

      <!-- Add Relay -->
      <div class="flex gap-2">
        <input
          type="text"
          id="new-relay-input"
          placeholder="wss://relay.example.com"
          class="flex-1 win95-inset px-3 py-2 rounded text-sm"
          style="color: var(--color-textPrimary); background: var(--color-bgPrimary);"
        />
        <button onclick="addRelay()" class="pixel-button pixel-clip px-4 py-2 text-sm" style="color: var(--color-textPrimary);">
          ‚ûï Add Relay
        </button>
      </div>

      <div class="mt-4 text-xs win95-inset p-3 rounded" style="background: var(--color-bgPrimary); color: var(--color-textMuted);">
        <p class="mb-2"><strong>‚ÑπÔ∏è Pre-Alpha Status:</strong></p>
        <ul class="list-disc list-inside space-y-1 text-xs">
          <li>Saves are currently held in memory when loaded</li>
          <li>During development, saves can be read from memory or saved to disk for debugging</li>
          <li>Relay-based save synchronization is the core feature of Pubkey Quest</li>
          <li>Full relay functionality will be implemented after pre-alpha</li>
        </ul>
      </div>
    </div>

    <!-- Account Info (if logged in) -->
    <div id="account-info-section" class="hidden mb-8">
      <h2 class="text-2xl font-bold mb-4">üë§ Account Info</h2>
      <div class="win95-inset p-4 rounded-lg space-y-2">
        <div class="flex justify-between">
          <span style="color: var(--color-textMuted);">Public Key:</span>
          <span id="account-npub" class="font-mono text-sm" style="color: var(--color-textHighlighted);">-</span>
        </div>
        <div class="flex justify-between">
          <span style="color: var(--color-textMuted);">Display Name:</span>
          <span id="account-name" style="color: var(--color-textPrimary);">-</span>
        </div>
      </div>
    </div>

    <!-- Back to Home -->
    <div class="text-center mt-8">
      <a href="/" class="pixel-button pixel-clip px-8 py-3" style="color: var(--color-textPrimary);">
        ‚Üê Back to Home
      </a>
    </div>
  </div>
</div>

<script>
  // Theme selection
  function selectTheme(themeName) {
    if (window.themeManager) {
      window.themeManager.setTheme(themeName);
      updateThemeSelection();
      showMessage(`‚úÖ Theme changed to ${themeName}`, 'success');
    }
  }

  // Update theme selection UI
  function updateThemeSelection() {
    if (!window.themeManager) return;

    const currentTheme = window.themeManager.getCurrentTheme();
    const options = document.querySelectorAll('.theme-option');

    options.forEach(option => {
      const theme = option.getAttribute('data-theme');
      if (theme === currentTheme) {
        option.classList.add('theme-swatch-selected');
        option.style.borderColor = 'var(--color-textHighlighted)';
      } else {
        option.classList.remove('theme-swatch-selected');
        option.style.borderColor = '';
      }
    });
  }

  // Add relay
  function addRelay() {
    const input = document.getElementById('new-relay-input');
    const relayUrl = input.value.trim();

    if (!relayUrl) {
      showMessage('‚ùå Please enter a relay URL', 'error');
      return;
    }

    if (!relayUrl.startsWith('wss://') && !relayUrl.startsWith('ws://')) {
      showMessage('‚ùå Relay URL must start with wss:// or ws://', 'error');
      return;
    }

    if (window.relayManager) {
      const success = window.relayManager.addRelay(relayUrl);
      if (success) {
        showMessage(`‚úÖ Added relay: ${relayUrl}`, 'success');
        input.value = '';
        renderRelayList();
      } else {
        showMessage('‚ùå Relay already exists', 'error');
      }
    }
  }

  // Remove relay
  function removeRelay(relayUrl) {
    if (window.relayManager) {
      window.relayManager.removeRelay(relayUrl);
      showMessage(`‚úÖ Removed relay: ${relayUrl}`, 'success');
      renderRelayList();
    }
  }

  // Test relay connection
  async function testRelay(relayUrl) {
    if (window.relayManager) {
      showMessage(`‚è≥ Testing connection to ${relayUrl}...`, 'info');
      const success = await window.relayManager.testRelay(relayUrl);
      if (success) {
        showMessage(`‚úÖ Connected to ${relayUrl}`, 'success');
      } else {
        showMessage(`‚ùå Failed to connect to ${relayUrl}`, 'error');
      }
      renderRelayList();
    }
  }

  // Render relay list
  function renderRelayList() {
    if (!window.relayManager) return;

    const relayListContainer = document.getElementById('relay-list');
    const relays = window.relayManager.getRelays();

    if (relays.length === 0) {
      relayListContainer.innerHTML = `
        <div class="text-center py-4" style="color: var(--color-textMuted);">
          No relays configured. Add one above to get started.
        </div>
      `;
      return;
    }

    relayListContainer.innerHTML = relays.map(relay => `
      <div class="flex items-center justify-between py-2 px-3 win95-outset rounded">
        <div class="flex-1">
          <div class="font-mono text-sm" style="color: var(--color-textPrimary);">${relay.url}</div>
          <div class="text-xs" style="color: var(--color-textMuted);">
            ${relay.connected ? '‚úÖ Connected' : '‚è∏Ô∏è Not tested'}
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="testRelay('${relay.url}')" class="text-xs px-2 py-1 win95-button rounded" style="color: var(--color-textPrimary);">
            üîç Test
          </button>
          <button onclick="removeRelay('${relay.url}')" class="text-xs px-2 py-1 win95-button rounded" style="color: rgb(239, 68, 68);">
            ‚ùå
          </button>
        </div>
      </div>
    `).join('');
  }

  // Update account info
  function updateAccountInfo() {
    const accountSection = document.getElementById('account-info-section');
    const npubElement = document.getElementById('account-npub');
    const nameElement = document.getElementById('account-name');

    if (window.sessionManager && window.sessionManager.isAuthenticated()) {
      accountSection?.classList.remove('hidden');

      if (window.profileManager && window.profileManager.getProfile()) {
        const profile = window.profileManager.getProfile();
        if (npubElement) npubElement.textContent = profile.npub?.slice(0, 20) + '...' || '-';
        if (nameElement) nameElement.textContent = profile.display_name || profile.name || '-';
      }
    } else {
      accountSection?.classList.add('hidden');
    }
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      updateThemeSelection();
      renderRelayList();
      updateAccountInfo();
    });
  } else {
    updateThemeSelection();
    renderRelayList();
    updateAccountInfo();
  }

  // Listen for profile updates
  window.addEventListener('profile-updated', updateAccountInfo);
  window.addEventListener('auth-changed', updateAccountInfo);

  // Listen for theme changes (from other tabs)
  window.addEventListener('theme-changed', updateThemeSelection);
</script>
{{end}}
