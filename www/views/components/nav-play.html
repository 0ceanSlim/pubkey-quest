{{define "nav-play"}}
<!-- Login/Profile Button -->
<button
  id="login-btn"
  onclick="handleLoginClick()"
  class="login-button-yellow pixel-clip p-2 hover:opacity-80 transition flex-shrink-0 flex items-center gap-2"
  title="Login"
>
  <span class="text-base flex items-center gap-2" id="login-btn-content">
    üóùÔ∏è<span class="hidden sm:inline"> Login</span>
  </span>
</button>

<!-- Login Modal (Hidden by default) -->
<div
  id="login-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideLoginModal()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-[95vw] sm:max-w-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-2 sm:p-6 md:p-8">
      <!-- Header -->
      <div class="text-center mb-3">
        <h2 class="text-xl sm:text-3xl font-bold mb-1 flex items-center justify-center gap-2" style="color: var(--color-textHighlighted);">
          <img src="/res/img/static/logo.png" alt="Pubkey Quest" class="inline-block" style="height: 1.5em; width: auto; image-rendering: pixelated;">
          Pubkey Quest
          <img src="/res/img/static/logo.png" alt="Pubkey Quest" class="inline-block" style="height: 1.5em; width: auto; image-rendering: pixelated;">
        </h2>
        <p class="text-xs sm:text-sm" style="color: var(--color-textMuted);">Login with your Nostr identity to save your progress</p>
      </div>

      <!-- Auth Result (inline status messages) -->
      <div id="auth-result" class="mb-3"></div>

      <!-- Login Methods -->
      <div class="space-y-2 mb-3">
        <!-- Generate New Keys -->
        <div class="win95-inset p-2 sm:p-3">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="text-2xl sm:text-4xl">‚ú®</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1 text-xs sm:text-sm" style="color: var(--color-textPrimary);">New to Nostr?</h4>
              <p class="text-[10px] sm:text-sm mb-1" style="color: var(--color-textMuted);">Generate a new keypair and start your adventure</p>
              <button
                onclick="generateNewKeys()"
                class="new-nostr-button-purple px-2 py-1.5 pixel-clip text-xs sm:text-sm w-full sm:w-auto"
              >
                ‚ú® Generate Keys
              </button>
            </div>
          </div>
        </div>

        <!-- Browser Extension -->
        <div class="win95-inset p-2 sm:p-3">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="text-2xl sm:text-4xl">üîó</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1 text-xs sm:text-sm" style="color: var(--color-textPrimary);">Browser Extension</h4>
              <p class="text-[10px] sm:text-sm mb-1" style="color: var(--color-textMuted);">Use Alby, nos2x, or other Nostr browser extensions</p>
              <button
                onclick="showExtensionDetection()"
                class="action-button-primary px-2 py-1.5 pixel-clip text-xs sm:text-sm w-full sm:w-auto"
              >
                üîó Extension
              </button>
            </div>
          </div>
        </div>

        <!-- Amber Signer (Combined: QR + Direct) -->
        <div class="win95-inset p-2 sm:p-3">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="text-2xl sm:text-4xl">üì±</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1 text-xs sm:text-sm" style="color: var(--color-textPrimary);">Amber Signer</h4>
              <p class="text-[10px] sm:text-sm mb-1" style="color: var(--color-textMuted);">Login with Amber app - QR for desktop or direct on mobile</p>
              <button
                onclick="showAmberOptions()"
                class="amber-button-orange px-2 py-1.5 pixel-clip text-xs sm:text-sm w-full sm:w-auto"
              >
                üì± Amber
              </button>
            </div>
          </div>
        </div>


        <!-- Private Key -->
        <div class="win95-inset p-2 sm:p-3">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="text-2xl sm:text-4xl">üóùÔ∏è</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1 text-xs sm:text-sm" style="color: var(--color-textPrimary);">Private Key</h4>
              <p class="text-[10px] sm:text-sm mb-1" style="color: var(--color-textMuted);">Login with your nsec or hex private key (encrypted with password for session)</p>
              <button
                onclick="showPrivateKeyForm()"
                class="private-key-button-red px-2 py-1.5 pixel-clip text-xs sm:text-sm w-full sm:w-auto"
              >
                üóùÔ∏è Private Key
              </button>
            </div>
          </div>
        </div>
      </div>


      <!-- Info Section -->
      <div class="text-[10px] sm:text-xs text-center mb-2" style="color: var(--color-textMuted);">
        <p>üîê Your keys are never sent to our servers</p>
        <p class="mt-0.5">All signing happens locally in your browser or signer app</p>
      </div>

      <!-- Close Button -->
      <button
        onclick="hideLoginModal()"
        class="w-full win95-button pixel-clip px-2 py-1.5 text-xs font-medium"
        style="color: var(--color-textPrimary);"
      >
        Close
      </button>
    </div>
  </div>
</div>

<!-- Private Key Modal (Initially Hidden) -->
<div
  id="private-key-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hidePrivateKeyForm()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-[95vw] sm:max-w-md max-h-[95vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-2 sm:p-6">
      <h3 class="text-lg sm:text-2xl font-bold mb-2 text-center" style="color: var(--color-textHighlighted);">üóùÔ∏è Private Key</h3>
      <div class="space-y-2">
        <div>
          <label class="block text-xs font-medium mb-1" style="color: var(--color-textSecondary);">Private Key</label>
          <input
            type="password"
            id="private-key-modal-input"
            class="w-full win95-inset px-2 py-1.5 focus:outline-none font-mono text-xs"
            style="color: var(--color-textPrimary); background-color: var(--color-bgPrimary);"
            placeholder="nsec1... or hex private key"
          />
        </div>
        <div>
          <label class="block text-xs font-medium mb-1" style="color: var(--color-textSecondary);">Encryption Password</label>
          <input
            type="password"
            id="encryption-password-modal-input"
            class="w-full win95-inset px-2 py-1.5 focus:outline-none text-xs"
            style="color: var(--color-textPrimary); background-color: var(--color-bgPrimary);"
            placeholder="Password to encrypt your key"
          />
        </div>
        <div class="text-xs win95-inset p-2" style="color: var(--color-textMuted);">
          <p>üîí Your private key will be encrypted with your password and stored securely for this session only.</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <button
            onclick="loginWithPrivateKeyAndPassword()"
            class="flex-1 action-button-primary pixel-clip px-2 py-1.5 text-xs"
          >
            üîë Login
          </button>
          <button
            onclick="hidePrivateKeyForm()"
            class="flex-1 win95-button pixel-clip px-2 py-1.5 text-xs"
            style="color: var(--color-textPrimary);"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Generated Keys Modal (Initially Hidden) -->
<div
  id="generated-keys-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideGeneratedKeys()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-[95vw] sm:max-w-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-2 sm:p-6">
      <h3 class="text-lg sm:text-2xl font-bold mb-2 text-center" style="color: var(--color-textHighlighted);">‚ú® New Keys!</h3>
      <div class="space-y-2">
        <div>
          <label class="block text-xs font-bold mb-1" style="color: var(--color-textHighlighted);">üìÑ Public Key (npub)</label>
          <div class="flex flex-col sm:flex-row gap-1">
            <div class="flex-1 win95-inset p-1.5 text-[10px] sm:text-xs font-mono break-all overflow-x-auto" style="color: var(--color-textHighlighted); background: var(--color-bgPrimary); max-height: 60px;" id="gen-npub"></div>
            <button onclick="copyToClipboard('gen-npub', 'üìÑ Public key')" class="action-button-secondary px-3 py-1.5 pixel-clip text-xs flex-shrink-0">üìã Copy</button>
          </div>
        </div>
        <div>
          <label class="block text-xs font-bold mb-1" style="color: rgb(239, 68, 68);">üîí Private Key (nsec)</label>
          <div class="flex flex-col sm:flex-row gap-1">
            <div class="flex-1 win95-inset p-1.5 text-[10px] sm:text-xs font-mono break-all overflow-x-auto" style="color: rgb(239, 68, 68); background: var(--color-bgPrimary); max-height: 60px;" id="gen-nsec"></div>
            <button onclick="copyToClipboard('gen-nsec', 'üîí Private key')" class="action-button-secondary px-3 py-1.5 pixel-clip text-xs flex-shrink-0">üìã Copy</button>
          </div>
        </div>
        <div class="text-[10px] sm:text-xs win95-outset p-2 pixel-clip" style="background: rgb(153, 27, 27); color: rgb(255, 255, 255); border: 2px solid rgb(239, 68, 68);">
          <p class="font-bold text-xs sm:text-sm">‚ö†Ô∏è CRITICAL - SAVE YOUR PRIVATE KEY!</p>
          <p class="mt-1">This is the ONLY way to access your account. <strong>It cannot be recovered or changed by anyone.</strong> Copy and store it in a password manager or write it down securely. Anyone with this key controls your account.</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <button
            onclick="useGeneratedKeys()"
            class="flex-1 action-button-primary pixel-clip px-2 py-1.5 text-xs"
          >
            ‚úÖ I Saved It
          </button>
          <button
            onclick="hideGeneratedKeys()"
            class="flex-1 win95-button pixel-clip px-2 py-1.5 text-xs"
            style="color: var(--color-textPrimary);"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Encryption Password Modal for Generated Keys -->
<div
  id="encryption-password-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideEncryptionPasswordModal()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-[95vw] sm:max-w-md max-h-[95vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-2 sm:p-6">
      <h3 class="text-lg sm:text-2xl font-bold mb-3 text-center" style="color: var(--color-textHighlighted);">üîí Secure Your Session</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--color-textSecondary);">Set Encryption Password</label>
          <input
            type="password"
            id="gen-encryption-password-input"
            class="w-full win95-inset px-3 py-2 focus:outline-none text-sm"
            style="color: var(--color-textPrimary); background-color: var(--color-bgPrimary);"
            placeholder="Enter password for this session"
            onkeypress="if(event.key === 'Enter') loginWithGeneratedKeys()"
          />
        </div>
        <div class="text-xs win95-inset p-3" style="color: var(--color-textMuted); background: var(--color-bgPrimary);">
          <p>üîí Your private key will be encrypted with this password and stored securely for this session only.</p>
        </div>
        <div class="text-sm win95-inset p-3 pixel-clip" style="background: var(--color-bgPrimary); color: var(--color-textPrimary);">
          <p class="font-bold mb-2">üí° Recommendation</p>
          <p class="mb-2">For easier access, consider using a browser extension or mobile signer:</p>
          <ul class="space-y-2 text-xs">
            <li>
              <a href="https://chromewebstore.google.com/detail/nos2x/kpgefcfmnafjgpblomihpgmejjdanjjp" target="_blank" class="inline-flex items-center gap-1 hover:opacity-80" style="color: var(--color-textHighlighted); text-decoration: underline;">
                <img src="/res/img/static/nos2x.png" alt="nos2x" class="inline-block" style="height: 1.8em; width: auto; image-rendering: pixelated;">
                <span>nos2x</span>
              </a>
              <span style="color: var(--color-textMuted);"> - Browser extension for desktop apps</span>
            </li>
            <li>
              <a href="https://github.com/greenart7c3/Amber?tab=readme-ov-file#amber-nostr-event-signer-for-android" target="_blank" class="inline-flex items-center gap-1 hover:opacity-80" style="color: var(--color-textHighlighted); text-decoration: underline;">
                <img src="/res/img/static/amber.png" alt="Amber" class="inline-block" style="height: 1.8em; width: auto; image-rendering: pixelated;">
                <span>Amber Signer</span>
              </a>
              <span style="color: var(--color-textMuted);"> -
                <img src="/res/img/static/android.png" alt="Android" class="inline-block" style="height: 1.8em; width: auto; image-rendering: pixelated;">
                Android signing app
              </span>
            </li>
          </ul>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <button
            onclick="loginWithGeneratedKeys()"
            class="flex-1 action-button-primary pixel-clip px-3 py-2 text-sm"
          >
            üîë Continue
          </button>
          <button
            onclick="cancelEncryptionPassword()"
            class="flex-1 win95-button pixel-clip px-3 py-2 text-sm"
            style="color: var(--color-textPrimary);"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Amber Options Modal (QR + Direct) -->
<div
  id="nostr-connect-qr-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideNostrConnectQR()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-[95vw] sm:max-w-lg max-h-[95vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-2 sm:p-6">
      <!-- Header -->
      <h3 class="text-lg sm:text-2xl font-bold mb-2 text-center" style="color: var(--color-textHighlighted);">üì± Amber Signer</h3>
      <p class="text-xs sm:text-sm text-center mb-3" style="color: var(--color-textMuted);">Choose your login method</p>

      <!-- Direct Button (for mobile devices) -->
      <div class="mb-3">
        <button
          onclick="loginWithAmber()"
          class="w-full amber-button-orange pixel-clip px-3 py-2 text-sm font-medium"
        >
          üì± Open Amber
        </button>
        <p class="text-[10px] text-center mt-1" style="color: var(--color-textMuted);">Use this if you're on your Android phone with Amber installed</p>
      </div>

      <div class="text-center text-xs mb-2" style="color: var(--color-textMuted);">
        ‚Äî OR ‚Äî
      </div>

      <!-- QR Code Section Header -->
      <div class="text-center mb-2">
        <h4 class="text-sm font-bold" style="color: var(--color-textPrimary);">üì∑ Scan QR Code (Desktop Login)</h4>
        <p class="text-[10px]" style="color: var(--color-textMuted);">Scan with Amber on your phone to login on this desktop</p>
      </div>

      <!-- Connection Status -->
      <div id="nostr-connect-status" class="mb-3 p-2 win95-inset text-center">
        <p class="text-xs" style="color: var(--color-textPrimary);" id="nostr-connect-status-text">‚è≥ Click "Show QR Code" to start</p>
      </div>

      <!-- Show QR Button -->
      <button
        id="show-qr-btn"
        onclick="generateAmberQRCode()"
        class="w-full action-button-primary pixel-clip px-3 py-2 text-sm font-medium mb-3"
      >
        üì∑ Show QR Code
      </button>

      <!-- QR Code Display -->
      <div id="qr-code-container" class="hidden bg-white p-3 sm:p-4 rounded-lg mb-3 flex justify-center items-center min-h-[200px] sm:min-h-[280px]">
        <canvas id="nostr-connect-qr-canvas"></canvas>
      </div>

      <!-- Connection String (for manual entry) -->
      <div id="connection-string-container" class="hidden mb-3">
        <label class="block text-xs font-medium mb-1" style="color: var(--color-textSecondary);">Connection String:</label>
        <div class="flex flex-col sm:flex-row gap-2">
          <input
            type="text"
            id="nostr-connect-uri"
            readonly
            class="flex-1 win95-inset px-2 py-1.5 focus:outline-none font-mono text-[10px] sm:text-xs"
            style="color: var(--color-textPrimary); background-color: var(--color-bgPrimary);"
            placeholder="nostrconnect://..."
          />
          <button
            onclick="copyNostrConnectURI()"
            class="action-button-primary pixel-clip px-2 py-1.5 text-xs w-full sm:w-auto"
          >
            üìã Copy
          </button>
        </div>
        <p class="text-[10px] mt-1" style="color: var(--color-textMuted);">Or paste this into Amber manually</p>
      </div>

      <!-- Close Button -->
      <button
        onclick="hideNostrConnectQR()"
        class="w-full win95-button pixel-clip px-2 py-1.5 text-xs font-medium"
        style="color: var(--color-textPrimary);"
      >
        Close
      </button>
    </div>
  </div>
</div>

<!-- Extension Detection Modal -->
<div
  id="extension-detection-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideExtensionDetection()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-[95vw] sm:max-w-md max-h-[95vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-2 sm:p-6">
      <h3 class="text-lg sm:text-2xl font-bold mb-2 text-center" style="color: var(--color-textHighlighted);">üîó Browser Extension</h3>

      <!-- Detection Status -->
      <div id="extension-status" class="mb-3 text-center">
        <p class="text-xs sm:text-sm" style="color: var(--color-textMuted);">Detecting extension...</p>
      </div>

      <!-- Extension Info (shown when detected) -->
      <div id="extension-info" class="hidden mb-3 win95-inset p-2 sm:p-3">
        <div class="text-center">
          <p class="text-lg sm:text-2xl mb-1">‚úÖ</p>
          <p class="text-xs sm:text-sm font-bold mb-1" style="color: var(--color-textPrimary);">Extension Detected!</p>
          <p class="text-[10px] sm:text-xs" style="color: var(--color-textMuted);" id="extension-name">Nostr Extension</p>
        </div>
      </div>

      <!-- Error Info (shown when not detected) -->
      <div id="extension-error" class="hidden mb-3 win95-outset p-2 sm:p-3" style="background: rgb(153, 27, 27); border: 2px solid rgb(239, 68, 68);">
        <div class="text-center">
          <p class="text-lg sm:text-2xl mb-1">‚ùå</p>
          <p class="text-xs sm:text-sm font-bold mb-1" style="color: rgb(255, 255, 255);">No Extension Found</p>
          <p class="text-[10px] sm:text-xs" style="color: rgb(255, 255, 255);">Please install a Nostr extension like Alby or nos2x</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row gap-2">
        <button
          id="open-extension-btn"
          onclick="proceedWithExtensionLogin()"
          class="hidden flex-1 action-button-primary pixel-clip px-2 py-1.5 text-xs"
        >
          üîì Open Extension
        </button>
        <button
          onclick="hideExtensionDetection()"
          class="flex-1 win95-button pixel-clip px-2 py-1.5 text-xs"
          style="color: var(--color-textPrimary);"
        >
          Back
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Modal with animated GIF -->
<div
  id="loading-modal"
  class="hidden fixed inset-0 z-[60] flex items-center justify-center"
  style="background-color: rgba(0, 0, 0, 0.85);"
>
  <div
    class="win95-outset pixel-clip p-4 sm:p-8 text-center"
    style="border: 4px solid var(--color-textPrimary);"
  >
    <img
      src="/res/img/loading.gif"
      alt="Loading..."
      class="mx-auto mb-4"
      style="width: 64px; height: 64px; image-rendering: pixelated;"
    >
    <p
      id="loading-text"
      class="text-sm sm:text-lg font-bold mb-4"
      style="color: var(--color-textPrimary);"
    >
      Loading...
    </p>
    <button
      id="loading-modal-cancel"
      onclick="window.cancelLogin ? window.cancelLogin() : hideLoadingModal()"
      class="win95-button pixel-clip px-4 py-2 text-xs sm:text-sm"
      style="color: var(--color-textPrimary);"
    >
      Cancel
    </button>
  </div>
</div>

<script>
// Global variable to store generated private key
if (typeof generatedPrivateKey === 'undefined') {
  var generatedPrivateKey = null;
}

// Show auth result inline (like Grain)
function showAuthResult(type, message) {
  let className, icon;

  if (type === 'success') {
    className = 'win95-outset p-3 rounded';
    icon = '‚úÖ';
  } else if (type === 'error') {
    className = 'win95-outset p-3 rounded';
    icon = '‚ùå';
  } else if (type === 'loading') {
    className = 'win95-outset p-3 rounded';
    icon = '‚è≥';
  } else {
    className = 'win95-inset p-3 rounded';
    icon = '‚ÑπÔ∏è';
  }

  const resultDiv = document.getElementById('auth-result');
  if (resultDiv) {
    resultDiv.innerHTML = `<div class="${className}" style="color: var(--color-textPrimary);"><p>${icon} ${message}</p></div>`;
  }
}

// Clear auth result
function clearAuthResult() {
  const resultDiv = document.getElementById('auth-result');
  if (resultDiv) {
    resultDiv.innerHTML = '';
  }
}

// Show loading modal with animated GIF
window.showLoadingModal = function(text = 'Loading...') {
  const modal = document.getElementById('loading-modal');
  const loadingText = document.getElementById('loading-text');
  if (modal && loadingText) {
    loadingText.textContent = text;
    modal.classList.remove('hidden');
  }
};

// Hide loading modal
window.hideLoadingModal = function() {
  const modal = document.getElementById('loading-modal');
  if (modal) {
    modal.classList.add('hidden');
  }
};

// Cancel login operation
window.cancelLogin = function() {
  window.hideLoadingModal();
  if (typeof showMessage === 'function') {
    showMessage('Login cancelled', 'info');
  }

  // Emit cancellation event if sessionManager is available
  if (window.sessionManager) {
    window.sessionManager.emit('authenticationFailed', { method: 'user_cancelled', error: 'User cancelled login' });
  }
};

// Show extension detection modal
function showExtensionDetection() {
  // Hide main login modal
  hideLoginModal();

  // Show detection modal
  const modal = document.getElementById('extension-detection-modal');
  if (modal) {
    modal.classList.remove('hidden');
  }

  // Reset UI state
  document.getElementById('extension-status').classList.remove('hidden');
  document.getElementById('extension-info').classList.add('hidden');
  document.getElementById('extension-error').classList.add('hidden');
  document.getElementById('open-extension-btn').classList.add('hidden');

  // Detect extension
  setTimeout(() => {
    detectExtension();
  }, 500); // Small delay for better UX
}

// Hide extension detection modal
function hideExtensionDetection() {
  const modal = document.getElementById('extension-detection-modal');
  if (modal) {
    modal.classList.add('hidden');
  }

  // Show login modal again
  showLoginModal();
}

// Detect if Nostr extension is available
function detectExtension() {
  const statusDiv = document.getElementById('extension-status');
  const infoDiv = document.getElementById('extension-info');
  const errorDiv = document.getElementById('extension-error');
  const openBtn = document.getElementById('open-extension-btn');
  const extensionNameEl = document.getElementById('extension-name');

  if (window.nostr) {
    // Extension found!
    statusDiv.classList.add('hidden');
    infoDiv.classList.remove('hidden');
    openBtn.classList.remove('hidden');

    // Try to get extension name if available
    if (window.nostr.name) {
      extensionNameEl.textContent = window.nostr.name;
    } else {
      extensionNameEl.textContent = 'Nostr Extension';
    }
  } else {
    // No extension found
    statusDiv.classList.add('hidden');
    errorDiv.classList.remove('hidden');
  }
}

// Proceed with extension login (called from "Open Extension" button)
async function proceedWithExtensionLogin() {
  // Hide extension detection modal
  const modal = document.getElementById('extension-detection-modal');
  if (modal) {
    modal.classList.add('hidden');
  }

  // Show loading modal
  if (typeof showLoadingModal === 'function') {
    showLoadingModal('Requesting access from extension...');
  }

  // Call the actual login function from auth.js
  if (typeof loginWithExtension === 'function') {
    await loginWithExtension();
  } else if (window.sessionManager) {
    try {
      await window.sessionManager.loginWithExtension();
    } catch (error) {
      console.error('Extension login error:', error);
      if (typeof hideLoadingModal === 'function') {
        hideLoadingModal();
      }
      if (typeof showMessage === 'function') {
        showMessage('‚ùå Extension login failed: ' + error.message, 'error');
      }
      showLoginModal(); // Show login modal again on error
    }
  }
}

function handleLoginClick() {
  // Check if user is already logged in
  if (window.sessionManager && window.sessionManager.isAuthenticated()) {
    // User is logged in - show profile dropdown
    toggleProfileDropdown();
  } else {
    // User not logged in - show login modal
    showLoginModal();
  }
}

// Toggle profile dropdown menu
function toggleProfileDropdown() {
  // Check if dropdown already exists
  let dropdown = document.getElementById('profile-dropdown');

  if (dropdown) {
    // Remove existing dropdown
    dropdown.remove();
    return;
  }

  // Create dropdown element
  dropdown = document.createElement('div');
  dropdown.id = 'profile-dropdown';

  // Get theme button position for positioning (align dropdown with theme button)
  const themeBtn = document.getElementById('theme-switcher-btn');
  const loginBtn = document.getElementById('login-btn');
  const buttonRect = themeBtn ? themeBtn.getBoundingClientRect() : loginBtn.getBoundingClientRect();

  // Style the dropdown with Win95 theme
  dropdown.style.cssText = `
    position: fixed;
    top: ${buttonRect.bottom + 8}px;
    right: ${window.innerWidth - buttonRect.right}px;
    background: var(--color-bgSecondary);
    min-width: 300px;
    z-index: 1000;
    font-family: inherit;
  `;
  dropdown.className = 'win95-outset pixel-clip p-2';

  // Get profile info
  const profile = window.profileManager ? window.profileManager.getProfile() : null;
  const session = window.sessionManager ? window.sessionManager.getSession() : null;

  let displayName = 'User';
  let profilePicture = null;

  if (profile) {
    displayName = profile.display_name || profile.name || (session?.npub ? session.npub.slice(0, 12) + '...' : 'User');
    profilePicture = profile.picture;
  } else if (session?.npub) {
    displayName = session.npub.slice(0, 12) + '...';
  }

  // Create dropdown content with profile section
  dropdown.innerHTML = `
    <!-- Profile Section -->
    <div id="profile-info-section" class="win95-inset pixel-clip p-3 mb-2 flex items-center gap-3 cursor-default transition-all" style="background: var(--color-bgPrimary);">
      <div class="flex-1 min-w-0 flex items-center gap-3">
        ${profilePicture ?
          `<img src="${profilePicture}" alt="Profile" class="w-10 h-10 rounded-full object-cover flex-shrink-0" style="image-rendering: auto; border: 2px solid var(--color-textHighlighted);">` :
          `<div class="w-10 h-10 rounded-full win95-inset flex items-center justify-center flex-shrink-0" style="background: var(--color-bgSecondary); border: 2px solid var(--color-textMuted);">
            <span style="color: var(--color-textMuted); font-size: 1.25rem;">üë§</span>
           </div>`
        }
        <div class="flex-1 min-w-0">
          <div class="font-bold text-sm truncate" style="color: var(--color-textHighlighted);">
            ${profile && (profile.display_name || profile.name) ? (profile.display_name || profile.name) : (session?.npub ? session.npub.slice(0, 12) + '...' : 'Anonymous')}
          </div>
          ${profile && (profile.display_name || profile.name) && session?.npub ?
            `<div class="text-xs truncate" style="color: var(--color-textMuted);">${session.npub.slice(0, 16) + '...'}</div>` :
            ''
          }
        </div>
      </div>
    </div>

    <!-- Menu Items -->
    <div class="space-y-1">
      <button onclick="navigateToSaves()" class="w-full win95-button pixel-clip px-3 py-2 text-xs flex items-center gap-2 hover:opacity-80" style="color: var(--color-textPrimary);">
        <span>üíæ</span>
        <span>My Saves</span>
      </button>
      <button onclick="navigateToSettings()" class="w-full win95-button pixel-clip px-3 py-2 text-xs flex items-center gap-2 hover:opacity-80" style="color: var(--color-textPrimary);">
        <span>‚öôÔ∏è</span>
        <span>Settings</span>
      </button>
      <button onclick="handleDropdownLogout()" class="w-full win95-button pixel-clip px-3 py-2 text-xs flex items-center gap-2 hover:opacity-80" style="color: rgb(239, 68, 68);">
        <span>üö™</span>
        <span>Logout</span>
      </button>
    </div>
  `;

  // Add hover effect to profile section
  const profileSection = dropdown.querySelector('#profile-info-section');
  if (profileSection) {
    profileSection.addEventListener('mouseenter', function() {
      this.style.background = 'var(--color-bgSecondary)';
      this.style.boxShadow = '0 0 8px rgba(255, 215, 0, 0.3)';
    });
    profileSection.addEventListener('mouseleave', function() {
      this.style.background = 'var(--color-bgPrimary)';
      this.style.boxShadow = 'none';
    });
  }

  // Add to page
  document.body.appendChild(dropdown);

  // Close dropdown when clicking elsewhere
  setTimeout(() => {
    const closeDropdown = (event) => {
      if (!dropdown.contains(event.target) && !loginBtn.contains(event.target)) {
        dropdown.remove();
        document.removeEventListener('click', closeDropdown);
      }
    };
    document.addEventListener('click', closeDropdown);
  }, 100);
}

// Navigate to saves page
function navigateToSaves() {
  const dropdown = document.getElementById('profile-dropdown');
  if (dropdown) dropdown.remove();
  window.location.href = '/saves';
}

// Navigate to settings page
function navigateToSettings() {
  const dropdown = document.getElementById('profile-dropdown');
  if (dropdown) dropdown.remove();
  window.location.href = '/settings';
}

// Handle logout from dropdown
async function handleDropdownLogout() {
  // Close dropdown first
  const dropdown = document.getElementById('profile-dropdown');
  if (dropdown) dropdown.remove();

  if (window.sessionManager) {
    try {
      await window.sessionManager.logout();
      showMessage('‚úÖ Logged out successfully', 'success');
      updateLoginButton();
      // Reload or redirect after logout
      setTimeout(() => {
        window.location.href = '/';
      }, 500);
    } catch (error) {
      console.error('Logout error:', error);
      showMessage('‚ùå Logout failed: ' + error.message, 'error');
    }
  }
}

// Update login button to show profile or login
function updateLoginButton() {
  const button = document.getElementById('login-btn');
  const buttonContent = document.getElementById('login-btn-content');

  console.log('üîç updateLoginButton called:', {
    button: !!button,
    buttonContent: !!buttonContent,
    sessionManager: !!window.sessionManager,
    isAuthenticated: window.sessionManager?.isAuthenticated()
  });

  if (!button || !buttonContent) {
    console.warn('‚ùå Login button or content not found');
    return;
  }

  if (window.sessionManager && window.sessionManager.isAuthenticated()) {
    // Get profile info
    const profile = window.profileManager ? window.profileManager.getProfile() : null;
    const session = window.sessionManager.getSession();

    console.log('üîÑ Updating login button:', {
      hasProfile: !!profile,
      displayName: profile?.display_name,
      name: profile?.name,
      picture: profile?.picture,
      npub: session?.npub?.slice(0, 12)
    });

    let displayName = 'User';
    let profilePicture = null;

    // Determine display name and picture
    if (profile && (profile.display_name || profile.name)) {
      displayName = profile.display_name || profile.name;
      profilePicture = profile.picture;
      console.log('‚úÖ Using profile data:', displayName, profilePicture ? 'with pfp' : 'no pfp');
    } else if (session?.npub) {
      // No display name, use truncated npub (6 characters)
      displayName = session.npub.slice(0, 6) + '...';
      profilePicture = profile?.picture || null;
      console.log('‚ö†Ô∏è No profile data, using npub fallback:', displayName);
    }

    // Update button to show profile (text on left, pic on right)
    if (profilePicture) {
      buttonContent.innerHTML = `
        <span class="hidden sm:inline truncate">${displayName}</span>
        <img src="${profilePicture}" alt="Profile" class="w-6 h-6 rounded-full object-cover flex-shrink-0" style="image-rendering: auto; border: 2px solid var(--color-textHighlighted);">
      `;
    } else {
      // No profile picture, show anonymous icon
      buttonContent.innerHTML = `
        <span class="hidden sm:inline truncate">${displayName}</span>
        <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0" style="background: var(--color-bgSecondary); border: 1px solid var(--color-textMuted);">
          <span style="font-size: 0.75rem;">üë§</span>
        </div>
      `;
    }
    button.title = displayName;

    // Remove pink background, use neutral styling
    button.className = 'win95-button pixel-clip p-2 hover:opacity-80 transition flex-shrink-0 flex items-center gap-2';
    button.style.color = 'var(--color-textPrimary)';
  } else {
    // User is not logged in - show login button
    buttonContent.innerHTML = 'üóùÔ∏è<span class="hidden sm:inline"> Login</span>';
    button.title = 'Login';

    // Reset to yellow login button styling
    button.className = 'login-button-yellow pixel-clip p-2 hover:opacity-80 transition flex-shrink-0 flex items-center gap-2';
    button.style.color = '';
  }
}

// Backwards compatibility - keep old function name
function updateLoginButtonState() {
  updateLoginButton();
}

function showLoginModal() {
  const modal = document.getElementById('login-modal');
  modal.classList.remove('hidden');
}

function hideLoginModal() {
  document.getElementById('login-modal').classList.add('hidden');
  hidePrivateKeyForm();
  hideGeneratedKeys();
}

function showPrivateKeyForm() {
  hideLoginModal();
  document.getElementById('private-key-modal').classList.remove('hidden');
}

function hidePrivateKeyForm() {
  document.getElementById('private-key-modal').classList.add('hidden');
  const input = document.getElementById('private-key-modal-input');
  const passwordInput = document.getElementById('encryption-password-modal-input');
  if (input) input.value = '';
  if (passwordInput) passwordInput.value = '';
}

// Login with private key and password
async function loginWithPrivateKeyAndPassword() {
  if (!window.sessionManager) {
    showMessage('‚ùå Session manager not available', 'error');
    return;
  }

  const privateKey = document.getElementById('private-key-modal-input')?.value?.trim();
  const password = document.getElementById('encryption-password-modal-input')?.value?.trim();

  if (!privateKey) {
    showMessage('‚ùå Please enter your private key', 'error');
    return;
  }

  if (!password) {
    showMessage('‚ùå Please enter an encryption password', 'error');
    return;
  }

  try {
    // Show loading modal with gif
    if (typeof showLoadingModal === 'function') {
      showLoadingModal('Logging in with private key...');
    }

    // Pass password as metadata for encryption
    await window.sessionManager.loginWithPrivateKey(privateKey, { password });

    // Clear inputs for security
    document.getElementById('private-key-modal-input').value = '';
    document.getElementById('encryption-password-modal-input').value = '';

    hidePrivateKeyForm();

    // Redirect to saves page on successful login
    window.location.href = '/saves';
  } catch (error) {
    console.error('Private key login error:', error);

    // Hide loading modal on error
    if (typeof hideLoadingModal === 'function') {
      hideLoadingModal();
    }

    showMessage('‚ùå Private key login failed: ' + error.message, 'error');
  }
}

// Copy to clipboard function with mobile fallback
function copyToClipboard(elementId, label) {
  const element = document.getElementById(elementId);
  if (!element) return;

  const text = element.textContent;
  if (!text) return;

  // Try modern clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showMessage(`‚úÖ ${label} copied!`, 'success');
    }).catch(err => {
      console.error('Clipboard API failed:', err);
      fallbackCopyTextToClipboard(text, label);
    });
  } else {
    // Fallback for older browsers and mobile
    fallbackCopyTextToClipboard(text, label);
  }
}

// Fallback copy method using textarea
function fallbackCopyTextToClipboard(text, label) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.top = '0';
  textArea.style.left = '0';
  textArea.style.width = '2em';
  textArea.style.height = '2em';
  textArea.style.padding = '0';
  textArea.style.border = 'none';
  textArea.style.outline = 'none';
  textArea.style.boxShadow = 'none';
  textArea.style.background = 'transparent';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    const successful = document.execCommand('copy');
    if (successful) {
      showMessage(`‚úÖ ${label} copied!`, 'success');
    } else {
      showMessage('‚ùå Failed to copy to clipboard', 'error');
    }
  } catch (err) {
    console.error('Fallback copy failed:', err);
    showMessage('‚ùå Failed to copy to clipboard', 'error');
  }

  document.body.removeChild(textArea);
}

function hideGeneratedKeys() {
  const modal = document.getElementById('generated-keys-modal');
  modal.classList.add('hidden');

  // Only clear if encryption modal is also hidden (meaning user cancelled everything)
  const encryptionModal = document.getElementById('encryption-password-modal');
  if (encryptionModal && encryptionModal.classList.contains('hidden')) {
    document.getElementById('gen-npub').textContent = '';
    document.getElementById('gen-nsec').textContent = '';
    window.generatedPrivateKey = null;
    generatedPrivateKey = null;
  }
}

function showGeneratedKeys(keyPair) {
  hideLoginModal();
  document.getElementById('gen-npub').textContent = keyPair.npub;
  document.getElementById('gen-nsec').textContent = keyPair.nsec;
  generatedPrivateKey = keyPair.nsec;
  window.generatedPrivateKey = keyPair.nsec; // Also store in window scope
  document.getElementById('generated-keys-modal').classList.remove('hidden');
}

async function useGeneratedKeys() {
  const privateKey = window.generatedPrivateKey || generatedPrivateKey;
  if (privateKey) {
    // Hide generated keys modal and show encryption password modal
    hideGeneratedKeys();
    showEncryptionPasswordModal();
  } else {
    showMessage('‚ùå No keys available', 'error');
  }
}

function showEncryptionPasswordModal() {
  const modal = document.getElementById('encryption-password-modal');
  if (modal) {
    modal.classList.remove('hidden');
    // Focus the password input after a brief delay for the modal to render
    setTimeout(() => {
      const input = document.getElementById('gen-encryption-password-input');
      if (input) input.focus();
    }, 100);
  } else {
    console.error('encryption-password-modal element not found!');
  }
}

function hideEncryptionPasswordModal() {
  document.getElementById('encryption-password-modal').classList.add('hidden');
  document.getElementById('gen-encryption-password-input').value = '';
}

function cancelEncryptionPassword() {
  // Hide encryption modal
  hideEncryptionPasswordModal();

  // Clear all generated key data for security
  document.getElementById('gen-npub').textContent = '';
  document.getElementById('gen-nsec').textContent = '';
  window.generatedPrivateKey = null;
  generatedPrivateKey = null;

  // Show login modal again
  showLoginModal();
}

async function loginWithGeneratedKeys() {
  const password = document.getElementById('gen-encryption-password-input')?.value?.trim();

  if (!password) {
    showMessage('‚ùå Please enter an encryption password', 'error');
    return;
  }

  console.log('Checking for private key:', {
    window: window.generatedPrivateKey,
    local: generatedPrivateKey,
    keyPair: window.generatedKeyPair
  });

  const privateKey = window.generatedPrivateKey || generatedPrivateKey || (window.generatedKeyPair && window.generatedKeyPair.nsec);

  console.log('Private key found:', privateKey);

  if (!privateKey) {
    showMessage('‚ùå No keys available', 'error');
    return;
  }

  try {
    // Hide encryption password modal
    hideEncryptionPasswordModal();

    // Show loading modal
    if (typeof showLoadingModal === 'function') {
      showLoadingModal('Logging in with new account...');
    }

    // Mark this as a new account so we skip relay lookups
    window._isNewAccount = true;

    // Use session manager to login with password encryption
    if (window.sessionManager) {
      await window.sessionManager.loginWithPrivateKey(privateKey, { password });
      // Clear private key after successful login for security
      window.generatedPrivateKey = null;
      generatedPrivateKey = null;
    } else {
      // Fallback to direct API call
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          private_key: privateKey,
          signing_method: 'encrypted_key',
          mode: 'write'
        })
      });

      if (!response.ok) throw new Error('Login failed');

      // Clear private key after successful login for security
      window.generatedPrivateKey = null;
      generatedPrivateKey = null;

      setTimeout(() => window.location.href = '/saves', 1000);
    }
  } catch (error) {
    // Hide loading modal on error
    if (typeof hideLoadingModal === 'function') {
      hideLoadingModal();
    }
    showMessage('‚ùå Login failed: ' + error.message, 'error');
    // Clear the flag on error
    window._isNewAccount = false;
  }
}

// Override the existing generateNewKeys function to work with dropdown
async function generateNewKeys() {
  if (!window.sessionManager) {
    showMessage('‚ùå Session manager not available', 'error');
    return;
  }

  try {
    const keyPair = await window.sessionManager.generateKeys();

    if (keyPair) {
      showGeneratedKeys(keyPair);
    } else {
      showMessage('‚ùå Failed to generate keys', 'error');
    }
  } catch (error) {
    console.error('Key generation error:', error);
    showMessage('‚ùå Key generation failed: ' + error.message, 'error');
  }
}

// Override the loginWithPrivateKey function to work with dropdown
async function loginWithPrivateKey(privateKeyParam) {
  if (!window.sessionManager) {
    showMessage('‚ùå Session manager not available', 'error');
    return;
  }

  const privateKey = privateKeyParam || document.querySelector('.private-key-input').value.trim();

  if (!privateKey) {
    showMessage('‚ùå Please enter your private key', 'error');
    return;
  }

  try {
    // Show loading modal with gif
    if (typeof showLoadingModal === 'function') {
      showLoadingModal('Logging in with private key...');
    }

    await window.sessionManager.loginWithPrivateKey(privateKey);

    // Clear the input for security
    if (!privateKeyParam) {
      document.querySelector('.private-key-input').value = '';
    }

    hideLoginModal();
    // Success handling is done by event listeners in auth.js
  } catch (error) {
    console.error('Private key login error:', error);

    // Hide loading modal on error
    if (typeof hideLoadingModal === 'function') {
      hideLoadingModal();
    }

    showMessage('‚ùå Private key login failed: ' + error.message, 'error');
  }
}

function showSaveSelection() {
  // Navigate to save selection page
  window.location.href = '/saves';
}

// Initialize button state when page loads
if (typeof window !== 'undefined') {
  // Update button state on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      // Add slight delay to ensure session manager is ready
      setTimeout(updateLoginButtonState, 100);
    });
  } else {
    // Add slight delay to ensure session manager is ready
    setTimeout(updateLoginButtonState, 100);
  }

  // Listen for profile updates from profile manager
  window.addEventListener('profile-updated', (event) => {
    console.log('üë§ Profile updated event received:', event.detail);
    updateLoginButton();
  });

  // Listen for generic auth changes (fired by various components)
  window.addEventListener('auth-changed', updateLoginButtonState);

  // Listen for authentication state changes
  if (window.sessionManager) {
    window.sessionManager.on('authenticationSuccess', updateLoginButtonState);
    window.sessionManager.on('loggedOut', updateLoginButtonState);
    window.sessionManager.on('sessionReady', updateLoginButtonState);
  } else {
    // Wait for session manager to be available
    const checkSessionManager = setInterval(() => {
      if (window.sessionManager) {
        clearInterval(checkSessionManager);
        window.sessionManager.on('authenticationSuccess', updateLoginButtonState);
        window.sessionManager.on('loggedOut', updateLoginButtonState);
        window.sessionManager.on('sessionReady', updateLoginButtonState);
        // Update immediately once session manager is available
        setTimeout(updateLoginButtonState, 50);
      }
    }, 100);
  }
}
</script>
{{end}}