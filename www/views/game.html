{{define "title"}}Pubkey Quest - Game{{end}} {{define "view"}}
<style>
  .bug-report-prod {
    max-width: 28rem;
  }
  .bug-report-debug {
    max-width: 90%;
  }
</style>
<!-- Hidden Game State Storage -->
<div id="game-state" style="display: none">
  <div id="character-data">
    {"hp": 0, "max_hp": 0, "mana": 0, "max_mana": 0, "location": "", "fatigue":
    0}
  </div>
  <div id="inventory-data">[]</div>
  <div id="equipment-data">{}</div>
  <div id="spell-data">[]</div>
  <div id="location-data">{"current": "", "discovered": []}</div>
  <div id="combat-data">null</div>
</div>

<!-- Static Game Data Storage -->
<div id="static-data" style="display: none">
  <div id="all-items">[]</div>
  <div id="all-spells">[]</div>
  <div id="all-monsters">[]</div>
  <div id="all-locations">[]</div>
  <div id="all-packs">[]</div>
  <div id="all-npcs">[]</div>
  <div id="all-music-tracks">[]</div>
</div>

<!-- Message Area (Fixed Position) -->
<div
  id="message-area"
  class="fixed z-50 max-w-sm space-y-2 top-4 right-4"
></div>

<!-- Logout Confirmation Modal -->
<div
  id="logout-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideLogoutModal()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-md"
    style="border: 4px solid var(--color-textPrimary); background: #2a2a2a;"
    onclick="event.stopPropagation()"
  >
    <div class="p-6">
      <h3 class="text-2xl font-bold mb-4 text-center" style="color: #dc2626;">‚ùå Logout</h3>
      <p class="text-center mb-6" style="color: #e5e7eb;">Are you sure you want to log out?</p>
      <div class="flex gap-3">
        <button
          onclick="confirmLogout()"
          class="flex-1 py-3 font-medium text-white"
          style="background: #dc2626; border-top: 2px solid #ef4444; border-left: 2px solid #ef4444; border-right: 2px solid #991b1b; border-bottom: 2px solid #991b1b;"
        >
          Yes, Logout
        </button>
        <button
          onclick="hideLogoutModal()"
          class="flex-1 py-3 font-medium text-white"
          style="background: #2a2a2a; border-top: 2px solid #4a4a4a; border-left: 2px solid #4a4a4a; border-right: 2px solid #1a1a1a; border-bottom: 2px solid #1a1a1a;"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bug Report Modal -->
<div
  id="bug-report-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideBugReportModal()"
>
  <div
    class="win95-outset pixel-clip w-full {{if .CustomData.DebugMode}}bug-report-debug{{else}}bug-report-prod{{end}}"
    style="border: 4px solid var(--color-textPrimary); background: #2a2a2a; max-height: 90vh; overflow-y: auto;"
    onclick="event.stopPropagation()"
  >
    <div class="p-6">
      {{if .CustomData.DebugMode}}
      <!-- Debug Mode: Show game state console -->
      <h3 class="text-2xl font-bold mb-4 text-center" style="color: #eab308;">üêõ Debug Console</h3>
      <p class="text-center mb-4 text-sm" style="color: #e5e7eb;">Current in-memory game state</p>

      <div class="mb-4">
        <pre id="debug-state-display" class="bg-black p-4 rounded text-xs overflow-x-auto" style="color: #00ff00; max-height: 60vh; font-family: 'Courier New', monospace;">Loading state...</pre>
      </div>

      <div class="flex gap-3 mb-3">
        <button
          onclick="copyDebugStateToClipboard()"
          class="flex-1 py-3 font-medium text-white"
          style="background: #1d4ed8; border-top: 2px solid #3b82f6; border-left: 2px solid #3b82f6; border-right: 2px solid #1e40af; border-bottom: 2px solid #1e40af;"
        >
          üìã Copy to Clipboard
        </button>
        <button
          onclick="refreshDebugState()"
          class="flex-1 py-3 font-medium text-white"
          style="background: #15803d; border-top: 2px solid #22c55e; border-left: 2px solid #22c55e; border-right: 2px solid #166534; border-bottom: 2px solid #166534;"
        >
          üîÑ Refresh View
        </button>
      </div>

      <div class="flex gap-3 mb-3">
        <button
          onclick="reloadFromSave()"
          class="flex-1 py-3 font-medium text-white"
          style="background: #dc2626; border-top: 2px solid #ef4444; border-left: 2px solid #ef4444; border-right: 2px solid #991b1b; border-bottom: 2px solid #991b1b;"
        >
          üíæ Reload from Save File
        </button>
      </div>

      <div class="flex gap-3">
        <button
          onclick="confirmBugReport()"
          class="flex-1 py-3 font-medium text-white"
          style="background: #ca8a04; border-top: 2px solid #eab308; border-left: 2px solid #eab308; border-right: 2px solid #854d0e; border-bottom: 2px solid #854d0e;"
        >
          Open GitHub
        </button>
        <button
          onclick="hideBugReportModal()"
          class="flex-1 py-3 font-medium text-white"
          style="background: #2a2a2a; border-top: 2px solid #4a4a4a; border-left: 2px solid #4a4a4a; border-right: 2px solid #1a1a1a; border-bottom: 2px solid #1a1a1a;"
        >
          Close
        </button>
      </div>
      {{else}}
      <!-- Production Mode: Standard bug report -->
      <h3 class="text-2xl font-bold mb-4 text-center" style="color: #eab308;">üêõ Report Bug</h3>
      <p class="text-center mb-6" style="color: #e5e7eb;">This button will open a new window to a GitHub issue. Please be as descriptive as you can and thank you for taking the time to make a report!</p>
      <div class="flex gap-3">
        <button
          onclick="confirmBugReport()"
          class="flex-1 py-3 font-medium text-white"
          style="background: #ca8a04; border-top: 2px solid #eab308; border-left: 2px solid #eab308; border-right: 2px solid #854d0e; border-bottom: 2px solid #854d0e;"
        >
          Open GitHub
        </button>
        <button
          onclick="hideBugReportModal()"
          class="flex-1 py-3 font-medium text-white"
          style="background: #2a2a2a; border-top: 2px solid #4a4a4a; border-left: 2px solid #4a4a4a; border-right: 2px solid #1a1a1a; border-bottom: 2px solid #1a1a1a;"
        >
          Cancel
        </button>
      {{end}}
      </div>
    </div>
  </div>
</div>

<!-- Main Game Container - Full Screen with Dark Win95 Style -->
<div
  id="game-app"
  class="fixed inset-0 flex items-start justify-start overflow-hidden text-white"
  style="background: #000000"
>
  <!-- Dark Win95 Style Game Window - Fixed 756x503 base size, scaled to fit -->
  <div
    id="game-window"
    class="flex flex-col"
    style="
      width: 756px;
      height: 503px;
      background: #2a2a2a;
      border-top: 2px solid #4a4a4a;
      border-left: 2px solid #4a4a4a;
      border-right: 2px solid #000000;
      border-bottom: 2px solid #000000;
      box-shadow: inset 1px 1px 0 #3a3a3a, inset -1px -1px 0 #1a1a1a;
      transform-origin: top left;
    "
  >
    <!-- Main Content Area: 2 columns (556px left, 200px right) -->
    <div class="flex flex-1 overflow-hidden">
      <!-- LEFT COLUMN (556px) - Scene/Text side-by-side + Actions below -->
      <div style="width: 556px;" class="flex flex-col">
        <!-- Scene and Text Box Row -->
        <div class="flex" style="height: 347px;">
          <!-- Text Box -->
          <div style="width: 209px;">
            {{template "game/game-text.html"}}
          </div>
          <!-- Scene (4:3 ratio) -->
          <div style="width: 347px;">
            {{template "game/scene.html"}}
          </div>
        </div>
        <!-- Action Buttons -->
        {{template "game/action-buttons.html"}}
      </div>

      <!-- RIGHT COLUMN (200px) - Character Info + Inventory + Menu Buttons -->
      <div style="width: 200px; max-width: 200px; overflow: hidden;" class="flex flex-col">
        {{template "game/player-stats.html"}}

        <!-- Top Tab Row (above content) -->
        {{template "game/tab-buttons-top.html"}}

        <!-- Tabbed Content Area (Inventory/Equipment) -->
        <div
          class="flex flex-col overflow-hidden"
          style="
            flex: 1;
            min-height: 0;
            width: 100%;
            box-sizing: border-box;
            background: #2a2a2a;
            border-top: 2px solid #1a1a1a;
            border-left: 2px solid #1a1a1a;
            border-right: 2px solid #3a3a3a;
            border-bottom: 2px solid #3a3a3a;
            box-shadow: inset -1px -1px 0 #4a4a4a, inset 1px 1px 0 #000000;
          "
        >
          <!-- Tab Content -->
          <div style="flex: 1; min-height: 0; padding: 4px; overflow-y: auto;">
            {{template "game/tabs/equipment.html"}}
            {{template "game/tabs/inventory.html"}}
            {{template "game/tabs/spells.html"}}
            {{template "game/tabs/questlog.html"}}
            {{template "game/tabs/stats.html"}}
            {{template "game/tabs/music.html"}}
            {{template "game/tabs/settings.html" .}}
          </div>
        </div>

        {{template "game/tab-buttons.html"}}
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    function switchTab(tabName) {
      const tabs = ["equipment", "inventory", "spells", "questlog", "stats", "music", "settings"];
      const panels = {
        equipment: document.getElementById("equipment-panel"),
        inventory: document.getElementById("inventory-panel"),
        spells: document.getElementById("spells-panel"),
        questlog: document.getElementById("questlog-panel"),
        stats: document.getElementById("stats-panel"),
        music: document.getElementById("music-panel"),
        settings: document.getElementById("settings-panel"),
      };
      const buttons = {
        equipment: document.getElementById("tab-equipment"),
        inventory: document.getElementById("tab-inventory"),
        spells: document.getElementById("tab-spells"),
        questlog: document.getElementById("tab-questlog"),
        stats: document.getElementById("tab-stats"),
        music: document.getElementById("tab-music"),
        settings: document.getElementById("btn-settings"),
      };

      tabs.forEach((tab) => {
        if (tab === tabName) {
          buttons[tab].style = "background: #1a1a1a; border-top: 2px solid #000000; border-left: 2px solid #000000; border-right: 2px solid #3a3a3a; border-bottom: 2px solid #3a3a3a;";
          panels[tab].classList.remove("hidden");
        } else {
          buttons[tab].style = "background: #2a2a2a; border-top: 2px solid #4a4a4a; border-left: 2px solid #4a4a4a; border-right: 2px solid #1a1a1a; border-bottom: 2px solid #1a1a1a;";
          panels[tab].classList.add("hidden");
        }
      });

      // Update music display when opening music tab
      if (tabName === 'music' && window.musicDisplay && window.musicDisplay.updateMusicDisplay) {
        window.musicDisplay.updateMusicDisplay();
      }
    }

    // Game UI Scaling System
    function scaleGameUI() {
      const gameWindow = document.getElementById('game-window');
      if (!gameWindow) return;

      const baseWidth = 756;
      const baseHeight = 503;
      const baseRatio = baseWidth / baseHeight; // ~1.503

      // Get viewport dimensions
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const viewportRatio = viewportWidth / viewportHeight;

      let scaleX, scaleY;

      // First, scale uniformly to fit within viewport (maintaining aspect ratio)
      const uniformScale = Math.min(viewportWidth / baseWidth, viewportHeight / baseHeight);

      // Then stretch to fill the remaining space
      if (viewportRatio > baseRatio) {
        // Viewport is wider - scale height uniformly, then stretch width to fill
        scaleY = uniformScale;
        scaleX = viewportWidth / baseWidth;
      } else {
        // Viewport is taller - scale width uniformly, then stretch height to fill
        scaleX = uniformScale;
        scaleY = viewportHeight / baseHeight;
      }

      // Apply the transform
      gameWindow.style.transform = `scale(${scaleX}, ${scaleY})`;
    }

    // Initialize scaling on page load
    window.addEventListener('load', () => {
      scaleGameUI();
      // Set inventory tab as default
      switchTab('inventory');
    });

    // Re-scale when window is resized
    window.addEventListener('resize', scaleGameUI);

    // Action button handlers
    function openBadges() {
      showMessage("üèÜ Badges system coming soon!", "info");
    }

    function openSettings() {
      switchTab('settings');
    }

    function manualSaveGame() {
      // Confirm before overwriting
      if (!confirm('‚ö†Ô∏è This will overwrite your existing save file. Are you sure you want to continue?')) {
        return;
      }

      const saveBtn = document.getElementById('manual-save-btn');
      const saveStatus = document.getElementById('save-status');

      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';
      saveStatus.textContent = 'Overwriting save file...';
      saveStatus.className = 'mt-2 text-xs text-yellow-400';

      saveGame().then(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save Now';
        saveStatus.textContent = '‚úÖ Save file overwritten successfully!';
        saveStatus.className = 'mt-2 text-xs text-green-400';

        setTimeout(() => {
          saveStatus.textContent = '';
        }, 3000);
      }).catch((error) => {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save Now';
        saveStatus.textContent = '‚ùå Save failed: ' + error.message;
        saveStatus.className = 'mt-2 text-xs text-red-400';
      });
    }

    const DEBUG_MODE = {{.CustomData.DebugMode}};

    async function showBugReportModal() {
      document.getElementById('bug-report-modal').classList.remove('hidden');

      // If in debug mode, load the current state
      if (DEBUG_MODE) {
        await refreshDebugState();
      }
    }

    function hideBugReportModal() {
      document.getElementById('bug-report-modal').classList.add('hidden');
    }

    function confirmBugReport() {
      const bugReportUrl = "https://github.com/0ceanSlim/pubkey-quest/issues/new?template=bug_report.md";
      showMessage("üêõ Opening bug report...", "info");
      window.open(bugReportUrl, "_blank");
    }

    // Debug console functions
    async function refreshDebugState() {
      if (!DEBUG_MODE) return;

      const debugDisplay = document.getElementById('debug-state-display');
      if (!debugDisplay) return;

      debugDisplay.textContent = 'Loading state...';

      try {
        const urlParams = new URLSearchParams(window.location.search);
        const saveID = urlParams.get('save');

        if (!window.sessionManager || !window.sessionManager.isAuthenticated()) {
          debugDisplay.textContent = 'Error: Not authenticated';
          return;
        }

        const session = window.sessionManager.getSession();

        // Fetch state from debug endpoint
        const response = await fetch(`/api/debug/state?npub=${session.npub}&save_id=${saveID}`);

        if (!response.ok) {
          throw new Error(`Failed to fetch debug state: ${response.status}`);
        }

        const data = await response.json();

        // Pretty print the JSON
        debugDisplay.textContent = JSON.stringify(data, null, 2);

      } catch (error) {
        console.error('Failed to load debug state:', error);
        debugDisplay.textContent = `Error loading state: ${error.message}`;
      }
    }

    async function copyDebugStateToClipboard() {
      const debugDisplay = document.getElementById('debug-state-display');
      if (!debugDisplay) return;

      try {
        await navigator.clipboard.writeText(debugDisplay.textContent);
        showMessage('‚úÖ Debug state copied to clipboard!', 'success');
      } catch (error) {
        console.error('Failed to copy to clipboard:', error);
        showMessage('‚ùå Failed to copy to clipboard', 'error');
      }
    }

    async function reloadFromSave() {
      if (!DEBUG_MODE) return;

      if (!confirm('‚ö†Ô∏è This will discard all in-memory changes and reload from the last saved file. Continue?')) {
        return;
      }

      try {
        showMessage('üíæ Reloading from save file...', 'info');

        const urlParams = new URLSearchParams(window.location.search);
        const saveID = urlParams.get('save');

        if (!window.sessionManager || !window.sessionManager.isAuthenticated()) {
          showMessage('‚ùå Not authenticated', 'error');
          return;
        }

        const session = window.sessionManager.getSession();

        // Force reload session from save file on disk
        const reloadResponse = await fetch('/api/session/reload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            npub: session.npub,
            save_id: saveID
          })
        });

        if (!reloadResponse.ok) {
          throw new Error(`Failed to reload: ${reloadResponse.status}`);
        }

        const reloadResult = await reloadResponse.json();
        console.log('‚úÖ Session reloaded from save file:', reloadResult);

        // Refresh game state from Go memory
        if (window.refreshGameState) {
          await window.refreshGameState();
        }

        // Refresh debug display
        await refreshDebugState();

        showMessage('‚úÖ Reloaded from save file!', 'success');

      } catch (error) {
        console.error('Failed to reload from save:', error);
        showMessage('‚ùå Failed to reload: ' + error.message, 'error');
      }
    }

    function showLogoutModal() {
      document.getElementById('logout-modal').classList.remove('hidden');
    }

    function hideLogoutModal() {
      document.getElementById('logout-modal').classList.add('hidden');
    }

    function confirmLogout() {
      hideLogoutModal();
      showMessage("üö™ Logging out...", "info");
      if (window.sessionManager) {
        window.sessionManager.logout();
      }
      setTimeout(() => {
        window.location.href = "/";
      }, 1000);
    }
  </script>

  <!-- OLD SCRIPTS - Preserved for rollback. To revert: uncomment these and remove new bundle below
  <script src="/scripts/core/session-manager.js?v=20251026t"></script>
  <script src="/scripts/core/game-api.js?v=20251026t"></script>
  <script src="/scripts/utils/item-helpers.js?v=20251026t"></script>
  <script src="/scripts/utils/character-helpers.js?v=20251026t"></script>
  <script src="/scripts/pages/game-ui.js?v=20251026t"></script>
  <script src="/scripts/core/auth.js?v=20251026t"></script>
  <script src="/scripts/systems/character-generator.js?v=20251026t"></script>
  <script src="/scripts/systems/game-state.js?v=20251026t"></script>
  <script src="/scripts/systems/game-logic.js?v=20251026t"></script>
  <script src="/scripts/systems/save-system.js?v=20251026t"></script>
  <script src="/scripts/systems/container-system.js?v=20251026t"></script>
  <script src="/scripts/systems/inventory-interactions.js?v=20251026t"></script>
  <script src="/scripts/pages/startup.js?v=20251026t"></script>
  -->

  <!-- NEW ES6 MODULE BUNDLE - Generated by Vite from src/entries/game.js -->
  <script type="module" src="/dist/game.js"></script>

  {{end}}
</div>
