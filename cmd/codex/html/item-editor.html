<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CODEX - Item Editor</title>
    <link rel="icon" type="image/png" href="/www/res/img/codex.png" />
    <link rel="stylesheet" href="/dist/codex/styles.css">
</head>
<body>
    <div class="codex-container">
        <div class="codex-header">
            <h1 class="codex-title">üì¶ ITEM EDITOR</h1>
            <button class="codex-btn pixel-clip-sm" onclick="window.location.href='/'">‚Üê BACK TO HOME</button>
        </div>

        <!-- Staging Toggle Button -->
        <button id="staging-toggle" class="staging-toggle hidden" onclick="toggleStagingPanel()">
            STAGING
            <span id="staging-badge" class="staging-change-badge">0</span>
        </button>

        <!-- Staging Panel (shown only in staging mode) -->
        <div id="staging-panel" class="staging-panel pixel-clip" style="display: none;">
            <button class="staging-panel-close" onclick="closeStagingPanel()">√ó</button>
            <div class="staging-header">
                <h3 class="staging-title">üì¶ STAGING CHANGES</h3>
                <span id="change-count" class="badge">0 changes</span>
            </div>

            <div class="staging-content">
                <div class="form-group">
                    <label class="codex-label">Your identifier (optional):</label>
                    <input
                        type="text"
                        id="npub-input"
                        placeholder="npub1... or username"
                        class="codex-input"
                    />
                    <p class="field-hint">This will be included in the PR for attribution</p>
                </div>

                <div class="staging-actions">
                    <button class="codex-btn pixel-clip-sm" onclick="viewStagedChanges()">üìã VIEW</button>
                    <button class="codex-btn pixel-clip-sm" style="background: #50fa7b; color: #000;" onclick="submitPR()">‚úÖ SUBMIT PR</button>
                    <button class="codex-btn pixel-clip-sm" style="background: #ff5555; color: #fff;" onclick="clearStaging()">üóëÔ∏è CLEAR</button>
                </div>
            </div>
        </div>

        <div class="codex-layout">
            <!-- LEFT SIDEBAR: Item List -->
            <div class="codex-sidebar win95-inset pixel-clip">
                <h2>Items (<span id="itemCount">0</span>)</h2>

                <!-- Filter Controls -->
                <div class="filter-section">
                    <input type="text" class="search-box" id="searchBox" placeholder="Search items..." onkeyup="applyFilters()" />

                    <select class="filter-select" id="typeFilter" onchange="applyFilters()">
                        <option value="">All Types</option>
                    </select>

                    <button class="codex-btn codex-btn-add pixel-clip-sm" onclick="createNewItem()">+ NEW ITEM</button>
                </div>

                <div id="itemListContainer"></div>
            </div>

            <!-- RIGHT PANEL: Editor -->
            <div class="codex-main win95-inset pixel-clip">
                <div id="emptyState" class="empty-state">
                    <p>Select an item from the list to edit or create a new item</p>
                </div>

                <div id="editorForm" style="display: none;">
                    <div class="editor-header">
                        <h2>
                            <span id="editorMode">Edit</span>: <span id="itemName"></span>
                        </h2>
                        <div class="editor-actions">
                            <button class="codex-btn codex-btn-primary pixel-clip-sm" onclick="saveItem()">üíæ Save</button>
                            <button class="codex-btn pixel-clip-sm" onclick="validateItem()">‚úì Validate</button>
                            <button class="codex-btn pixel-clip-sm" onclick="cancelEdit()">Cancel</button>
                            <button class="codex-btn pixel-clip-sm" style="background: #ff5555; color: #fff;" onclick="deleteItem()" id="deleteBtn">üóëÔ∏è Delete</button>
                        </div>
                    </div>

                    <div class="status-message" id="statusMessage"></div>

                    <!-- SECTION: Image & Basic Info (Side-by-side) -->
                    <div class="top-section">
                        <div class="image-section win95-inset pixel-clip">
                            <h3>üñºÔ∏è Image</h3>
                            <div class="image-preview-large">
                                <div id="imageContainer">
                                    <p style="color: #6272a4;">No image available</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Image Path *</label>
                                <input type="text" id="itemImage" placeholder="/res/img/items/longsword.png" readonly style="opacity: 0.6;" />
                            </div>
                            <div class="actions">
                                <button class="codex-btn pixel-clip-sm" onclick="openImageGenerator()">üé® Generate Image</button>
                                <button class="codex-btn pixel-clip-sm" onclick="checkImage()">üñºÔ∏è Check Image</button>
                            </div>
                            <div id="balanceDisplay" style="margin-top: 8px; font-size: 12px; color: #6272a4;"></div>
                        </div>

                        <div class="basic-info-section win95-inset pixel-clip">
                            <h3>üìã Basic Information</h3>

                            <div class="form-group">
                                <label>ID * <span class="field-hint">(filename, lowercase-with-hyphens)</span></label>
                                <input type="text" id="itemId" placeholder="longsword" />
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" id="itemNameInput" placeholder="Longsword" />
                                </div>
                                <div class="form-group">
                                    <label>Type *</label>
                                    <select id="itemType">
                                        <option value="">Select type...</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Rarity *</label>
                                    <select id="itemRarity">
                                        <option value="common">Common</option>
                                        <option value="uncommon">Uncommon</option>
                                        <option value="rare">Rare</option>
                                        <option value="legendary">Legendary</option>
                                        <option value="mythical">Mythical</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Price (GP) *</label>
                                    <input type="number" id="itemPrice" placeholder="0" />
                                </div>
                                <div class="form-group">
                                    <label>Weight (lbs) *</label>
                                    <input type="number" step="0.01" id="itemWeight" placeholder="1" />
                                </div>
                                <div class="form-group">
                                    <label>Stack Size *</label>
                                    <input type="number" id="itemStack" placeholder="1" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Description *</label>
                                <textarea id="itemDescription" placeholder="A well-balanced blade..."></textarea>
                            </div>

                        </div>
                    </div>


                    <!-- SECTION: Tags -->
                    <div class="codex-section win95-inset pixel-clip">
                        <h3>üè∑Ô∏è Tags</h3>
                        <div class="tag-editor">
                            <div class="tags-container" id="tagsContainer"></div>
                            <div class="tag-input-row">
                                <input type="text" id="newTagInput" placeholder="Add tag (e.g., equipment, consumable, container)" list="commonTags" />
                                <button class="codex-btn codex-btn-sm codex-btn-add pixel-clip-sm" onclick="addTag()">Add</button>
                            </div>
                            <datalist id="commonTags">
                                <option value="equipment">
                                <option value="consumable">
                                <option value="container">
                                <option value="ammunition">
                                <option value="versatile">
                                <option value="two-handed">
                                <option value="light">
                                <option value="heavy">
                                <option value="finesse">
                                <option value="thrown">
                                <option value="ranged">
                                <option value="melee">
                                <option value="healing">
                                <option value="light-source">
                            </datalist>
                        </div>
                    </div>

                    <!-- SECTION: Equipment Properties (conditional) -->
                    <div class="section conditional-section" id="equipmentSection" style="display: none;">
                        <h3>‚öîÔ∏è Equipment Properties</h3>
                        <div class="form-group">
                            <label>Gear Slot *</label>
                            <select id="gearSlot" required>
                                <option value="">Select slot...</option>
                                <option value="hands">Hands (Any Hand)</option>
                                <option value="mainhand">Main Hand Only</option>
                                <option value="offhand">Off Hand Only</option>
                                <option value="chest">Chest</option>
                                <option value="head">Head</option>
                                <option value="legs">Legs</option>
                                <option value="gloves">Gloves</option>
                                <option value="boots">Boots</option>
                                <option value="neck">Neck</option>
                                <option value="ring">Ring</option>
                                <option value="ammo">Ammo</option>
                                <option value="bag">Bag</option>
                            </select>
                        </div>
                    </div>

                    <!-- SECTION: Container Properties (conditional) -->
                    <div class="section conditional-section" id="containerSection" style="display: none;">
                        <h3>üì¶ Container Properties</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Container Slots *</label>
                                <input type="number" id="containerSlots" placeholder="20" />
                            </div>
                            <div class="form-group">
                                <label>Allowed Types *</label>
                                <select id="allowedTypes" multiple size="8">
                                    <option value="any">any (all items)</option>
                                </select>
                                <span class="field-hint">Hold Ctrl/Cmd to select multiple. First option = "any" accepts all items.</span>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: Armor Properties (conditional) -->
                    <div class="section conditional-section" id="armorSection" style="display: none;">
                        <h3>üõ°Ô∏è Armor Properties</h3>
                        <div class="form-group">
                            <label>AC *</label>
                            <input type="text" id="itemAC" placeholder="14 + Dex(max2)" />
                        </div>
                    </div>

                    <!-- SECTION: Weapon Properties (conditional) -->
                    <div class="section conditional-section" id="weaponSection" style="display: none;">
                        <h3>‚öîÔ∏è Weapon Properties</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Damage *</label>
                                <input type="text" id="itemDamage" placeholder="1d8 or 1d8,1d10" />
                            </div>
                            <div class="form-group">
                                <label>Damage Type *</label>
                                <select id="damageType">
                                    <option value="">None</option>
                                    <option value="slashing">Slashing</option>
                                    <option value="piercing">Piercing</option>
                                    <option value="bludgeoning">Bludgeoning</option>
                                    <option value="fire">Fire</option>
                                    <option value="cold">Cold</option>
                                    <option value="lightning">Lightning</option>
                                    <option value="poison">Poison</option>
                                    <option value="acid">Acid</option>
                                    <option value="psychic">Psychic</option>
                                    <option value="necrotic">Necrotic</option>
                                    <option value="radiant">Radiant</option>
                                    <option value="force">Force</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: Focus Properties (conditional) -->
                    <div class="section conditional-section" id="focusSection" style="display: none;">
                        <h3>‚ú® Focus Properties</h3>
                        <div class="form-group">
                            <label>Provides * <span class="field-hint">(spell component this focus provides unlimited)</span></label>
                            <select id="itemProvides">
                                <option value="">Select spell component...</option>
                            </select>
                        </div>
                    </div>

                    <!-- SECTION: Pack Properties (conditional) -->
                    <div class="section conditional-section" id="packSection" style="display: none;">
                        <h3>üì¶ Pack Contents</h3>
                        <div class="pack-editor">
                            <div class="pack-contents-container" id="packContentsContainer"></div>
                            <div class="pack-input-row">
                                <select id="newPackItemSelect" style="flex: 2;">
                                    <option value="">Select item to add...</option>
                                </select>
                                <input type="number" id="newPackItemQuantity" placeholder="Qty" min="1" value="1" style="flex: 0 0 80px;" />
                                <button class="codex-btn codex-btn-sm codex-btn-add pixel-clip-sm" onclick="addPackItem()">Add Item</button>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: Ranged Properties (conditional) -->
                    <div class="section conditional-section" id="rangedSection" style="display: none;">
                        <h3>üèπ Ranged Weapon Properties</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ammunition *</label>
                                <input type="text" id="ammunition" placeholder="arrows" />
                            </div>
                            <div class="form-group">
                                <label>Range *</label>
                                <input type="text" id="range" placeholder="80" />
                            </div>
                            <div class="form-group">
                                <label>Range (Long) *</label>
                                <input type="text" id="rangeLong" placeholder="320" />
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: Consumable Properties (conditional) -->
                    <div class="section conditional-section" id="consumableSection" style="display: none;">
                        <h3>üíä Consumable Effects</h3>

                        <!-- Current effects list -->
                        <div class="form-group">
                            <label>Active Effects</label>
                            <div class="tags-container" id="effectsContainer">
                                <span style="color: #6272a4; font-size: 12px;">No effects defined</span>
                            </div>
                        </div>

                        <!-- Add Stat Effect -->
                        <div style="border-top: 1px solid #44475a; padding-top: 12px; margin-top: 8px;">
                            <label style="display: block; margin-bottom: 8px; color: #f8f8f2; font-weight: bold; font-size: 13px;">Add Stat Change <span class="field-hint">(instant modification when consumed)</span></label>
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Stat</label>
                                    <select id="newEffectType">
                                        <option value="">Select stat...</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Mode</label>
                                    <select id="newEffectMode">
                                        <option value="flat">Flat (+/- number)</option>
                                        <option value="dice">Dice (e.g. 2d4+2)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Value</label>
                                    <input type="number" id="newEffectValueFlat" placeholder="+/- 5" />
                                    <input type="text" id="newEffectValueDice" placeholder="2d4+2" style="display: none;" />
                                </div>
                                <div class="form-group" style="flex: 0 0 70px;">
                                    <label>Chance</label>
                                    <input type="number" id="newEffectChanceInline" min="1" max="100" value="100" placeholder="100" />
                                </div>
                                <div class="form-group" style="flex: 0 0 auto; display: flex; align-items: flex-end;">
                                    <button class="codex-btn codex-btn-sm codex-btn-add pixel-clip-sm" onclick="addInlineEffect()" style="margin-bottom: 2px;">Add</button>
                                </div>
                            </div>
                        </div>

                        <!-- Add Named Effect -->
                        <div style="border-top: 1px solid #44475a; padding-top: 12px; margin-top: 8px;">
                            <label style="display: block; margin-bottom: 8px; color: #f8f8f2; font-weight: bold; font-size: 13px;">Add Status Effect <span class="field-hint">(timed buff/debuff from game-data/effects/)</span></label>
                            <div class="form-row">
                                <div class="form-group" style="flex: 3;">
                                    <label>Effect</label>
                                    <select id="newNamedEffect" onchange="window.previewNamedEffect()">
                                        <option value="">Select status effect...</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 0 0 70px;">
                                    <label>Chance</label>
                                    <input type="number" id="newEffectChance" min="1" max="100" value="100" placeholder="100" />
                                </div>
                                <div class="form-group" style="flex: 0 0 auto; display: flex; align-items: flex-end;">
                                    <button class="codex-btn codex-btn-sm codex-btn-add pixel-clip-sm" onclick="addNamedEffect()" style="margin-bottom: 2px;">Add</button>
                                </div>
                            </div>
                            <div id="namedEffectPreview" style="display: none; padding: 8px; background: #1a1a2e; border: 1px solid #44475a; border-radius: 4px; font-size: 12px; color: #8be9fd;">
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: Notes -->
                    <div class="codex-section win95-inset pixel-clip">
                        <h3>üìù Notes</h3>
                        <div class="notes-editor">
                            <div class="notes-container" id="notesContainer"></div>
                            <div class="tag-input-row">
                                <input type="text" id="newNoteInput" placeholder="Add note (e.g., Burns for 1 hour when lit)" />
                                <button class="codex-btn codex-btn-sm codex-btn-add pixel-clip-sm" onclick="addNote()">Add</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Changes Preview Modal -->
    <div id="changes-modal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeChangesModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--codex-purple);">üìã Staged Changes Preview</h2>
                <button class="btn btn-close" onclick="closeChangesModal()">‚úï</button>
            </div>

            <div id="changes-list" class="changes-list">
                <!-- Populated dynamically -->
            </div>

            <div class="modal-footer">
                <button onclick="closeChangesModal()" class="codex-btn pixel-clip-sm">Close</button>
                <button onclick="confirmSubmitPR()" class="codex-btn pixel-clip-sm" style="background: #50fa7b; color: #000;">Submit PR</button>
            </div>
        </div>
    </div>

    <!-- Image Generation Modal -->
    <div id="image-gen-modal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeImageGenModal()"></div>
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 style="color: var(--codex-purple);">üé® Generate Item Image</h2>
                <button class="btn btn-close" onclick="closeImageGenModal()">‚úï</button>
            </div>

            <div style="padding: 20px;">
                <!-- Balance & Model Selection -->
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Model</label>
                        <select id="imageGenModel">
                            <option value="bitforge">Bitforge (~$0.03)</option>
                            <option value="pixflux">Pixflux (~$0.05)</option>
                        </select>
                    </div>
                    <div style="flex: 1; text-align: right;">
                        <label>Account Balance</label>
                        <div id="imageGenBalance" style="font-size: 18px; color: var(--codex-green);">Loading...</div>
                    </div>
                </div>

                <!-- Prompt Preview -->
                <div class="form-group">
                    <label>Generated Prompt</label>
                    <textarea id="imageGenPrompt" readonly style="height: 60px; opacity: 0.8;"></textarea>
                </div>

                <!-- Image Comparison -->
                <div style="display: flex; gap: 20px; margin: 20px 0;">
                    <!-- Current Image -->
                    <div style="flex: 1; text-align: center;">
                        <label style="display: block; margin-bottom: 8px;">Current Image</label>
                        <div id="currentImagePreview" style="width: 128px; height: 128px; margin: 0 auto; background: #1a1a2e; border: 2px solid #44475a; display: flex; align-items: center; justify-content: center;">
                            <span style="color: #6272a4; font-size: 12px;">No image</span>
                        </div>
                    </div>

                    <!-- Generated Image -->
                    <div style="flex: 1; text-align: center;">
                        <label style="display: block; margin-bottom: 8px;">Generated Image</label>
                        <div id="generatedImagePreview" style="width: 128px; height: 128px; margin: 0 auto; background: #1a1a2e; border: 2px solid #44475a; display: flex; align-items: center; justify-content: center;">
                            <span style="color: #6272a4; font-size: 12px;">Click Generate</span>
                        </div>
                    </div>
                </div>

                <!-- Generation Status -->
                <div id="imageGenStatus" style="text-align: center; margin: 15px 0; color: #6272a4;"></div>
            </div>

            <div class="modal-footer">
                <button onclick="closeImageGenModal()" class="codex-btn pixel-clip-sm">Cancel</button>
                <button onclick="generateNewImage()" class="codex-btn codex-btn-primary pixel-clip-sm" id="generateBtn">üé® Generate ($0.03)</button>
                <button onclick="acceptGeneratedImage()" class="codex-btn pixel-clip-sm" style="background: #50fa7b; color: #000;" id="acceptBtn" style="display: none;">‚úÖ Accept & Save</button>
            </div>
        </div>
    </div>

    <script type="module" src="/dist/codex/item-editor.js"></script>
</body>
</html>
